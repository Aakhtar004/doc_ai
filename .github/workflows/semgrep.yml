# .github/workflows/semgrep.yml
name: Semgrep Security Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Semgrep
        run: python3 -m pip install semgrep

      - name: Run Semgrep
        run: |
          mkdir -p docs/reports/semgrep
          semgrep --config=auto --json --output docs/reports/semgrep/semgrep.json . || true
          semgrep --config=auto --sarif --output docs/reports/semgrep/semgrep.sarif . || true

      - name: Generate Semgrep summary
        run: |
          cat > docs/reports/semgrep/semgrep-summary.html <<EOF
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>Semgrep</title></head>
          <body><h1>ðŸ”Ž Semgrep Analysis</h1>
          <ul>
            <li><a href="semgrep.json">JSON</a></li>
            <li><a href="semgrep.sarif">SARIF</a></li>
          </ul></body></html>
          EOF
          
      - name: Sync with remote main (rebase)
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git pull --rebase origin main || true

      - name: Commit Semgrep report
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          branch: main
          commit_message: "ci: update Semgrep report"
          file_pattern: docs/reports/semgrep/**