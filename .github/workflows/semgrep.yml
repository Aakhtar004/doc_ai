# .github/workflows/semgrep.yml
name: ðŸ”Ž Semgrep Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_call: {}

jobs:
  analysis:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      security-events: write
    outputs:
      json-path: ${{ steps.run.outputs.json-path }}
      sarif-path: ${{ steps.run.outputs.sarif-path }}
      summary-path: ${{ steps.summary.outputs.summary-path }}
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep analysis
        id: run
        run: |
          python3 -m pip install semgrep
          mkdir -p reports/semgrep
          semgrep --config=auto --json --output=reports/semgrep/semgrep.json . || true
          semgrep --config=auto --sarif --output=reports/semgrep/semgrep.sarif . || true
          echo "json-path=reports/semgrep/semgrep.json" >> $GITHUB_OUTPUT
          echo "sarif-path=reports/semgrep/semgrep.sarif" >> $GITHUB_OUTPUT

      - name: Generate Semgrep summary
        id: summary
        run: |
          cat > reports/semgrep/semgrep-summary.html <<EOF
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>Semgrep</title></head>
          <body><h1>ðŸ”Ž Semgrep Analysis</h1>
          <ul>
            <li><a href="semgrep.json">JSON</a></li>
            <li><a href="semgrep.sarif">SARIF</a></li>
          </ul></body></html>
          EOF
          echo "summary-path=reports/semgrep/semgrep-summary.html" >> $GITHUB_OUTPUT