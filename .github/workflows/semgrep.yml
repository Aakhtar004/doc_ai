# .github/workflows/semgrep.yml
name: Semgrep Security Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  semgrep-scan:
    name: Scan & Publish Semgrep Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Semgrep + pandas
        run: pip install semgrep pandas

      - name: Run Semgrep (JSON output)
        run: |
          mkdir -p reports
          semgrep --config p/default \
                  --json --output reports/semgrep.json \
                  --include server.cjs \
                  --include api.mjs \
                  --include config/supabase.js \
                  --include routes/ \
                  --include services/ \
                  --include public/js/ \
                  --metrics off

      - name: Generate HTML report
        run: |
          python - <<'PYCODE'
          import json, pandas as pd

          data = json.load(open('reports/semgrep.json'))
          rows = []
          for r in data.get('results', []):
              rows.append({
                  'Check ID': r['check_id'],
                  'Path':     r['path'],
                  'Start':    r['start']['line'],
                  'End':      r['end']['line'],
                  'Message':  r['extra']['message'],
                  'Severity': r['extra']['severity']
              })
          df = pd.DataFrame(rows)
          html = f"""
          <!doctype html><html><head>
            <meta charset='utf-8'><title>Semgrep Report</title>
            <style>
              body {{ font-family: Arial; }}
              table {{ border-collapse: collapse; width: 100%; }}
              th, td {{ border: 1px solid #ccc; padding: 6px; }}
              th {{ background: #eee; }}
            </style>
          </head><body>
            <h1>Semgrep Security Report</h1>
            <p>Total findings: {len(df)}</p>
            {df.to_html(index=False)}
          </body></html>
          """
          open('reports/semgrep-report.html','w').write(html)
          PYCODE

      - name: Deploy report to GHâ€‘Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages
          destination_dir: semgrep
          keep_files: false
