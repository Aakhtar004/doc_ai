# .github/workflows/deploy.yml
name: ðŸš€ Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          rm -f package-lock.json
          npm install

      - name: Prepare docs structure
        run: |
          mkdir -p docs/reports/semgrep \
                   docs/reports/snyk \
                   docs/reports/sonar \
                   docs/reports/mutation \
                   docs/reports/bdd

      - name: Download Semgrep Reports
        uses: actions/download-artifact@v4
        with:
          name: semgrep-reports
          path: temp-reports/semgrep

      - name: Download Snyk Reports
        uses: actions/download-artifact@v4
        with:
          name: snyk-reports
          path: temp-reports/snyk

      - name: Download SonarCloud Reports
        uses: actions/download-artifact@v4
        with:
          name: sonar-reports
          path: temp-reports/sonar

      - name: Download Mutation Reports
        uses: actions/download-artifact@v4
        with:
          name: mutation-reports
          path: temp-reports/mutation

      - name: Download BDD Unit Report
        uses: actions/download-artifact@v4
        with:
          name: bdd-unit-report
          path: temp-reports/bdd/unit

      - name: Download BDD Integration Report
        uses: actions/download-artifact@v4
        with:
          name: bdd-integration-report
          path: temp-reports/bdd/integration

      - name: Download BDD UI Report
        uses: actions/download-artifact@v4
        with:
          name: bdd-ui-report
          path: temp-reports/bdd/ui

      - name: Copy all reports into docs
        run: |
          cp -R temp-reports/semgrep/* docs/reports/semgrep/ || true
          cp -R temp-reports/snyk/*    docs/reports/snyk/    || true
          cp -R temp-reports/sonar/*   docs/reports/sonar/   || true
          cp -R temp-reports/mutation/*docs/reports/mutation/|| true
          cp -R temp-reports/bdd/*     docs/reports/bdd/     || true

      - name: Generate main dashboard markdown
        run: |
          cat > docs/index.md <<EOF
          ---
          layout: default
          title: DocAI - Dashboard de Reportes
          ---
          
          # ðŸ“Š DocAI - Dashboard de Reportes de Calidad
          
          ## ðŸŽ¯ Reportes Disponibles
          - ðŸ›¡ï¸ [Semgrep](reports/semgrep/semgrep-summary.html)
          - ðŸ›¡ï¸ [Snyk](reports/snyk/snyk-summary.html)
          - ðŸŽ¯ [SonarCloud](reports/sonar/sonar-summary.html)
          - ðŸ§¬ [Mutation Testing](reports/mutation/mutation-summary.html)
          - ðŸ§ª [BDD Tests](reports/bdd/index.html)
          
          *Dashboard actualizado automÃ¡ticamente por GitHub Actions*
          EOF

      - name: Disable Jekyll processing
        run: touch docs/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs
          force_orphan: true
