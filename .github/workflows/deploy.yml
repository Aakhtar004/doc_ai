# .github/workflows/deploy.yml
name: Dashboard Unificado - Recopilación de Análisis

on:
  workflow_run:
    workflows: ["SonarQube Analysis and Node.js CI", "Pruebas de Mutaciones con Stryker"]
    types:
      - completed
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  collect-and-deploy:
    name: Recopilar Análisis y Desplegar Dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
      actions: read
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # ========== EJECUTAR SOLO SEMGREP (RÁPIDO) ==========
      - name: Run Semgrep Security Analysis
        id: semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: auto
          generateSarif: "1"
        continue-on-error: true
      
      # ========== DESCARGAR ARTEFACTOS DE OTROS WORKFLOWS ==========
      - name: Download SonarQube artifacts
        uses: actions/download-artifact@v4
        with:
          name: docugen-ai-build
          path: ./sonar-artifacts
        continue-on-error: true
      
      - name: Download Stryker artifacts
        uses: actions/download-artifact@v4
        with:
          name: stryker-reports
          path: ./stryker-artifacts
        continue-on-error: true
      
      # ========== CREAR ESTRUCTURA DEL DASHBOARD ==========
      - name: Create Dashboard Structure
        run: |
          mkdir -p ./dashboard/{semgrep,snyk,sonar,stryker,assets}
          
          # CSS optimizado y compacto
          cat > ./dashboard/assets/style.css << 'EOF'
          :root{--primary:#4f46e5;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6}
          .dashboard-header{background:linear-gradient(135deg,var(--primary),var(--success));min-height:50vh;display:flex;align-items:center}
          .analysis-card{transition:all 0.3s ease;border:none;border-radius:20px;height:100%;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
          .analysis-card:hover{transform:translateY(-8px);box-shadow:0 20px 25px rgba(0,0,0,0.1)}
          .card-semgrep{border-top:6px solid var(--danger)}.card-snyk{border-top:6px solid var(--info)}
          .card-sonar{border-top:6px solid var(--primary)}.card-stryker{border-top:6px solid var(--success)}
          .analysis-icon{width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1rem;font-size:2rem;color:white}
          .icon-semgrep{background:linear-gradient(135deg,var(--danger),#dc2626)}
          .icon-snyk{background:linear-gradient(135deg,var(--info),#2563eb)}
          .icon-sonar{background:linear-gradient(135deg,var(--primary),#6366f1)}
          .icon-stryker{background:linear-gradient(135deg,var(--success),#059669)}
          EOF
      
      # ========== GENERAR DASHBOARD PRINCIPAL ==========
      - name: Generate Main Dashboard
        run: |
          cat > ./dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Dashboard de Análisis - Doc AI (GDI-IA)</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
              <link href="./assets/style.css" rel="stylesheet">
          </head>
          <body>
              <header class="dashboard-header text-white">
                  <div class="container">
                      <div class="row align-items-center">
                          <div class="col-12 text-center">
                              <i class="fas fa-shield-alt mb-3" style="font-size: 4rem;"></i>
                              <h1 class="display-4 fw-bold mb-3">Dashboard de Análisis</h1>
                              <p class="lead mb-3">Sistema GDI-IA - Generador de Documentación IA</p>
                              <small class="opacity-75">Actualizado: $(date '+%Y-%m-%d %H:%M:%S UTC')</small>
                          </div>
                      </div>
                  </div>
              </header>
              
              <main class="container my-5">
                  <div class="row g-4">
                      <div class="col-lg-3 col-md-6">
                          <div class="card analysis-card card-semgrep">
                              <div class="card-body text-center p-4">
                                  <div class="analysis-icon icon-semgrep">
                                      <i class="fas fa-search-plus"></i>
                                  </div>
                                  <h4 class="fw-bold">Semgrep</h4>
                                  <p class="text-muted">Análisis de seguridad estático</p>
                                  <span class="badge bg-success mb-3">Completado</span>
                                  <a href="./semgrep/" class="btn btn-outline-danger w-100">
                                      <i class="fas fa-chart-line me-2"></i>Ver Reporte
                                  </a>
                              </div>
                          </div>
                      </div>
                      
                      <div class="col-lg-3 col-md-6">
                          <div class="card analysis-card card-snyk">
                              <div class="card-body text-center p-4">
                                  <div class="analysis-icon icon-snyk">
                                      <i class="fas fa-bug"></i>
                                  </div>
                                  <h4 class="fw-bold">Snyk</h4>
                                  <p class="text-muted">Vulnerabilidades en dependencias</p>
                                  <span class="badge bg-info mb-3">Pendiente</span>
                                  <a href="./snyk/" class="btn btn-outline-info w-100">
                                      <i class="fas fa-shield-virus me-2"></i>Ver Análisis
                                  </a>
                              </div>
                          </div>
                      </div>
                      
                      <div class="col-lg-3 col-md-6">
                          <div class="card analysis-card card-sonar">
                              <div class="card-body text-center p-4">
                                  <div class="analysis-icon icon-sonar">
                                      <i class="fas fa-microscope"></i>
                                  </div>
                                  <h4 class="fw-bold">SonarQube</h4>
                                  <p class="text-muted">Calidad de código</p>
                                  <span class="badge bg-success mb-3">Completado</span>
                                  <a href="./sonar/" class="btn btn-outline-primary w-100">
                                      <i class="fas fa-code me-2"></i>Ver Métricas
                                  </a>
                              </div>
                          </div>
                      </div>
                      
                      <div class="col-lg-3 col-md-6">
                          <div class="card analysis-card card-stryker">
                              <div class="card-body text-center p-4">
                                  <div class="analysis-icon icon-stryker">
                                      <i class="fas fa-vial"></i>
                                  </div>
                                  <h4 class="fw-bold">Stryker</h4>
                                  <p class="text-muted">Pruebas de mutación</p>
                                  <span class="badge bg-success mb-3">Completado</span>
                                  <a href="./stryker/" class="btn btn-outline-success w-100">
                                      <i class="fas fa-flask me-2"></i>Ver Mutaciones
                                  </a>
                              </div>
                          </div>
                      </div>
                  </div>
                  
                  <!-- Info del Proyecto -->
                  <div class="row mt-5">
                      <div class="col-12">
                          <div class="card">
                              <div class="card-header bg-light">
                                  <h5><i class="fas fa-info-circle me-2"></i>Proyecto Doc AI (GDI-IA)</h5>
                              </div>
                              <div class="card-body">
                                  <div class="row">
                                      <div class="col-md-6">
                                          <h6 class="fw-bold">Descripción:</h6>
                                          <p>Sistema generador de documentación impulsado por IA para DevStar Solutions</p>
                                          <h6 class="fw-bold">Tecnologías:</h6>
                                          <span class="badge bg-success me-1">Node.js</span>
                                          <span class="badge bg-dark me-1">Express</span>
                                          <span class="badge bg-primary me-1">Gemini AI</span>
                                          <span class="badge bg-info me-1">Supabase</span>
                                      </div>
                                      <div class="col-md-6">
                                          <h6 class="fw-bold">Análisis Ejecutados:</h6>
                                          <ul class="list-unstyled">
                                              <li><i class="fas fa-check text-success me-2"></i>Semgrep - Seguridad</li>
                                              <li><i class="fas fa-link text-primary me-2"></i>SonarCloud - Calidad</li>
                                              <li><i class="fas fa-check text-success me-2"></i>Stryker - Mutaciones</li>
                                          </ul>
                                          <a href="https://github.com/Aakhtar004/doc_ai" class="btn btn-sm btn-outline-dark" target="_blank">
                                              <i class="fab fa-github me-1"></i>Repositorio
                                          </a>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </main>
              
              <footer class="bg-dark text-white py-3">
                  <div class="container text-center">
                      <p class="mb-0">Dashboard GDI-IA | Generado el $(date '+%Y-%m-%d %H:%M:%S UTC')</p>
                  </div>
              </footer>
          </body>
          </html>
          EOF
      
      # ========== GENERAR REPORTES INDIVIDUALES ==========
      - name: Generate Individual Reports
        run: |
          # Función para crear navegación
          create_nav() {
              local current=$1
              local title=$2
              echo "
              <nav class=\"navbar navbar-dark bg-$current fixed-top\">
                  <div class=\"container\">
                      <a class=\"navbar-brand\" href=\"../index.html\">
                          <i class=\"fas fa-arrow-left me-2\"></i>Dashboard
                      </a>
                      <span class=\"navbar-text\">$title</span>
                  </div>
              </nav>
              <div style=\"height: 76px;\"></div>"
          }
          
          # Reporte Semgrep
          if [ -f "semgrep.sarif" ]; then
              python3 << 'EOF'
          import json, os
          from datetime import datetime
          
          def create_nav(color, title):
              return f"""
              <nav class="navbar navbar-dark bg-{color} fixed-top">
                  <div class="container">
                      <a class="navbar-brand" href="../index.html">
                          <i class="fas fa-arrow-left me-2"></i>Dashboard
                      </a>
                      <span class="navbar-text">{title}</span>
                  </div>
              </nav>
              <div style="height: 76px;"></div>"""
          
          # Procesar Semgrep
          try:
              with open('semgrep.sarif', 'r') as f:
                  data = json.load(f)
              
              results = []
              if 'runs' in data and len(data['runs']) > 0:
                  for result in data['runs'][0].get('results', []):
                      results.append({
                          'ruleId': result.get('ruleId', 'N/A'),
                          'level': result.get('level', 'info'),
                          'message': result.get('message', {}).get('text', 'No message')
                      })
              
              high = sum(1 for r in results if r['level'] == 'error')
              medium = sum(1 for r in results if r['level'] == 'warning')
              low = sum(1 for r in results if r['level'] == 'info')
              
              html = f"""
              <!DOCTYPE html>
              <html><head>
                  <meta charset="UTF-8">
                  <title>Semgrep - Doc AI</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
              </head><body>
                  {create_nav('danger', 'Análisis Semgrep')}
                  <div class="container my-4">
                      <h2><i class="fas fa-search-plus text-danger me-2"></i>Semgrep Security Analysis</h2>
                      <div class="row mb-4">
                          <div class="col-md-3"><div class="card bg-danger text-white"><div class="card-body text-center"><h3>{high}</h3><p class="mb-0">Alto</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-warning text-dark"><div class="card-body text-center"><h3>{medium}</h3><p class="mb-0">Medio</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-info text-white"><div class="card-body text-center"><h3>{low}</h3><p class="mb-0">Bajo</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-primary text-white"><div class="card-body text-center"><h3>{len(results)}</h3><p class="mb-0">Total</p></div></div></div>
                      </div>
              """
              
              if len(results) == 0:
                  html += '<div class="alert alert-success"><h5><i class="fas fa-check-circle me-2"></i>Sin vulnerabilidades</h5><p class="mb-0">No se encontraron vulnerabilidades de seguridad.</p></div>'
              else:
                  for result in results:
                      color = 'danger' if result['level'] == 'error' else 'warning' if result['level'] == 'warning' else 'info'
                      html += f"""
                      <div class="card mb-3 border-{color}">
                          <div class="card-header"><h6 class="mb-0"><span class="badge bg-{color} me-2">{result['level'].upper()}</span>{result['ruleId']}</h6></div>
                          <div class="card-body"><p class="mb-0">{result['message']}</p></div>
                      </div>"""
              
              html += '</div></body></html>'
              
              with open('./dashboard/semgrep/index.html', 'w') as f:
                  f.write(html)
              
              print("✅ Semgrep report generated")
          except Exception as e:
              print(f"❌ Error: {e}")
          EOF
          else
              echo '<html><body><h1>Semgrep - Sin datos</h1><p>No se encontró archivo SARIF</p></body></html>' > ./dashboard/semgrep/index.html
          fi
          
          # Reporte Snyk (mejorado)
          if [ -f "./snyk-reports/snyk-report.json" ] || [ -f "./snyk-reports/basic-report.json" ]; then
              python3 << 'EOF'
          import json, os
          
          try:
              # Intentar leer reporte real de Snyk
              if os.path.exists('./snyk-reports/snyk-report.json'):
                  with open('./snyk-reports/snyk-report.json', 'r') as f:
                      snyk_data = json.load(f)
                  vulnerabilities = snyk_data.get('vulnerabilities', [])
                  configured = True
              elif os.path.exists('./snyk-reports/basic-report.json'):
                  with open('./snyk-reports/basic-report.json', 'r') as f:
                      snyk_data = json.load(f)
                  vulnerabilities = []
                  configured = False
              else:
                  vulnerabilities = []
                  configured = False
              
              high = sum(1 for v in vulnerabilities if v.get('severity') == 'high')
              medium = sum(1 for v in vulnerabilities if v.get('severity') == 'medium')
              low = sum(1 for v in vulnerabilities if v.get('severity') == 'low')
              
              status_alert = """
              <div class="alert alert-warning">
                  <h5><i class="fas fa-exclamation-triangle me-2"></i>Snyk no configurado</h5>
                  <p>Para habilitar el análisis de Snyk, configure el secret SNYK_TOKEN en GitHub.</p>
                  <p class="mb-0">Vaya a Settings > Secrets and variables > Actions y agregue su token de Snyk.</p>
              </div>
              """ if not configured else f"""
              <div class="alert alert-success">
                  <h5><i class="fas fa-check-circle me-2"></i>Análisis completado</h5>
                  <p class="mb-0">Se analizaron las dependencias del proyecto exitosamente.</p>
              </div>
              """
              
              html = f"""
              <!DOCTYPE html>
              <html><head>
                  <meta charset="UTF-8">
                  <title>Snyk - Doc AI</title>
                  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
              </head><body>
                  <nav class="navbar navbar-dark bg-info fixed-top">
                      <div class="container">
                          <a class="navbar-brand" href="../index.html">
                              <i class="fas fa-arrow-left me-2"></i>Dashboard
                          </a>
                          <span class="navbar-text">Análisis Snyk</span>
                      </div>
                  </nav>
                  <div style="height: 76px;"></div>
                  <div class="container my-4">
                      <h2><i class="fas fa-bug text-info me-2"></i>Snyk Dependency Analysis</h2>
                      
                      {status_alert}
                      
                      <div class="row mb-4">
                          <div class="col-md-3"><div class="card bg-danger text-white"><div class="card-body text-center"><h3>{high}</h3><p class="mb-0">Alto</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-warning text-dark"><div class="card-body text-center"><h3>{medium}</h3><p class="mb-0">Medio</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-info text-white"><div class="card-body text-center"><h3>{low}</h3><p class="mb-0">Bajo</p></div></div></div>
                          <div class="col-md-3"><div class="card bg-primary text-white"><div class="card-body text-center"><h3>{len(vulnerabilities)}</h3><p class="mb-0">Total</p></div></div></div>
                      </div>
              """
              
              if len(vulnerabilities) == 0 and configured:
                  html += '<div class="alert alert-success"><h5><i class="fas fa-check-circle me-2"></i>Sin vulnerabilidades</h5><p class="mb-0">No se encontraron vulnerabilidades en las dependencias.</p></div>'
              elif len(vulnerabilities) > 0:
                  for vuln in vulnerabilities:
                      severity = vuln.get('severity', 'unknown')
                      color = 'danger' if severity == 'high' else 'warning' if severity == 'medium' else 'info'
                      html += f"""
                      <div class="card mb-3 border-{color}">
                          <div class="card-header"><h6 class="mb-0"><span class="badge bg-{color} me-2">{severity.upper()}</span>{vuln.get('title', 'Vulnerabilidad')}</h6></div>
                          <div class="card-body">
                              <p><strong>Paquete:</strong> {vuln.get('packageName', 'N/A')}</p>
                              <p class="mb-0">{vuln.get('description', 'Sin descripción')}</p>
                          </div>
                      </div>"""
              
              html += '</div></body></html>'
              
              with open('./dashboard/snyk/index.html', 'w') as f:
                  f.write(html)
              
              print("✅ Snyk report generated")
          except Exception as e:
              print(f"❌ Error generating Snyk report: {e}")
          EOF
          else
              echo "⚠️ No Snyk reports found, creating basic report"
              cat > ./dashboard/snyk/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head><meta charset="UTF-8"><title>Snyk - Doc AI</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head>
          <body><div class="container my-4"><h2>Snyk Analysis</h2><div class="alert alert-info"><p>Snyk analysis not configured yet.</p></div></div></body></html>
          EOF
          fi
          
          # Reporte SonarQube
          cat > ./dashboard/sonar/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head>
              <meta charset="UTF-8">
              <title>SonarQube - Doc AI</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
          </head><body>
              <nav class="navbar navbar-dark bg-primary fixed-top">
                  <div class="container">
                      <a class="navbar-brand" href="../index.html">
                          <i class="fas fa-arrow-left me-2"></i>Dashboard
                      </a>
                      <span class="navbar-text">Análisis SonarQube</span>
                  </div>
              </nav>
              <div style="height: 76px;"></div>
              <div class="container my-4">
                  <h2><i class="fas fa-microscope text-primary me-2"></i>SonarQube Code Quality</h2>
                  <div class="alert alert-success">
                      <h5><i class="fas fa-check-circle me-2"></i>Análisis Completado</h5>
                      <p>El análisis de calidad se ejecutó en SonarCloud.</p>
                      <a href="https://sonarcloud.io/project/overview?id=docaisc_docaipy" class="btn btn-primary" target="_blank">
                          <i class="fas fa-external-link-alt me-2"></i>Ver en SonarCloud
                      </a>
                  </div>
              </div>
          </body></html>
          EOF
          
          # Reporte Stryker
          cat > ./dashboard/stryker/index.html << 'EOF'
          <!DOCTYPE html>
          <html><head>
              <meta charset="UTF-8">
              <title>Stryker - Doc AI</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
          </head><body>
              <nav class="navbar navbar-dark bg-success fixed-top">
                  <div class="container">
                      <a class="navbar-brand" href="../index.html">
                          <i class="fas fa-arrow-left me-2"></i>Dashboard
                      </a>
                      <span class="navbar-text">Análisis Stryker</span>
                  </div>
              </nav>
              <div style="height: 76px;"></div>
              <div class="container my-4">
                  <h2><i class="fas fa-vial text-success me-2"></i>Stryker Mutation Testing</h2>
                  <div class="alert alert-success">
                      <h5><i class="fas fa-check-circle me-2"></i>Pruebas de Mutación</h5>
                      <p class="mb-0">Las pruebas de mutación se ejecutaron correctamente. Los reportes están disponibles en el workflow de Stryker.</p>
                  </div>
              </div>
          </body></html>
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Dashboard
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dashboard'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
