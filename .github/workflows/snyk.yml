name: Snyk Security Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install deps & Snyk
        run: |
          npm install
          npm install -g snyk

      - name: Run Snyk tests
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          mkdir -p docs/reports/snyk
          snyk test --json > docs/reports/snyk/snyk-deps.json || echo '{}' > docs/reports/snyk/snyk-deps.json
          snyk code test --json > docs/reports/snyk/snyk-code.json || echo '{}' > docs/reports/snyk/snyk-code.json

      - name: Generate Snyk summary
        run: |
          cat > docs/reports/snyk/snyk-summary.html <<EOF
          <!DOCTYPE html><html><head><meta charset="UTF-8"><title>Snyk</title></head>
          <body><h1>ğŸ›¡ï¸ Snyk Security</h1>
          <ul>
            <li><a href="snyk-deps.json">Dependencias</a></li>
            <li><a href="snyk-code.json">CÃ³digo</a></li>
          </ul></body></html>
          EOF

      - name: Commit Snyk report
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          branch: main
          commit_message: "ci: update Snyk report"
          file_pattern: docs/reports/snyk/**